# 自动删种功能

pt-tools 提供自动删种功能，帮助用户在长时间刷流过程中自动管理磁盘空间，避免硬盘被撑满。

[返回首页](../README.md)

## 目录

- [功能概述](#功能概述)
- [配置说明](#配置说明)
  - [基本设置](#基本设置)
  - [管理范围](#管理范围)
  - [删除条件](#删除条件)
  - [磁盘空间保护](#磁盘空间保护)
  - [保护规则](#保护规则)
- [执行逻辑](#执行逻辑)
- [H&R 保护](#hr-保护)
- [多下载器安全](#多下载器安全)
- [常见配置示例](#常见配置示例)

## 功能概述

自动删种功能定时检查下载器中的种子状态，根据用户配置的规则自动删除满足条件的种子及数据文件，释放磁盘空间。

**核心特点**：

- **安全优先**：默认只管理 pt-tools 自己推送的种子，不碰用户手动添加的
- **H&R 保护**：自动识别带有 H&R 要求的种子，在未满足做种时长前不会删除
- **灵活条件**：支持做种时间、分享率、不活跃时间等多种删除条件，支持 AND/OR 组合
- **磁盘保底**：磁盘空间保护机制（默认开启），空间不足时自动拦截新种子推送并按优先级清理存量
- **推送拦截**：RSS 自动下载和手动推送在磁盘空间低于阈值时自动停止，防止撑爆硬盘
- **Scope 严格隔离**：清理操作严格遵守管理范围设置，紧急清理也不会越界删除范围外的种子
- **多下载器安全**：每个下载器独立管理，通过数据库记录精确匹配

## 配置说明

在 Web 管理界面的「系统设置」页面底部，展开「自动删种」区域进行配置。

### 基本设置

| 配置项           | 默认值  | 说明                                 |
| ---------------- | ------- | ------------------------------------ |
| **启用自动删种** | 关      | 总开关                               |
| **检查间隔**     | 30 分钟 | 执行清理任务的时间间隔，最小 5 分钟  |
| **删除数据文件** | 开      | 删除种子时是否同时删除下载的数据文件 |

### 管理范围

提供三种模式，决定哪些种子会被自动删种管理：

| 模式                           | 说明                                                         | 安全性                             |
| ------------------------------ | ------------------------------------------------------------ | ---------------------------------- |
| **仅本应用推送的种子**（默认） | 通过数据库记录精确匹配，只管理 pt-tools 推送并记录在案的种子 | ⭐⭐⭐ 最安全                      |
| **按标签匹配**                 | 管理下载器中带有指定标签的所有种子                           | ⚠ 手动添加相同标签的种子也会被管理 |
| **所有种子**                   | 管理下载器中的全部种子                                       | ⚠⚠ 包括非本应用添加的种子          |

> **建议**：始终使用「仅本应用推送的种子」模式。其他模式仅在您完全理解风险后使用。

**Scope 隔离保证**：无论使用哪种管理范围，自动删种（包括紧急清理）都**严格遵守**所选范围，不会越界删除范围外的种子。例如选择「仅本应用推送的种子」时，即使磁盘空间极度紧张触发了紧急清理，也绝对不会删除您手动添加到下载器的种子。

### 删除条件

当种子满足配置的条件时，会被标记为可删除。

| 条件               | 说明                         | 示例    |
| ------------------ | ---------------------------- | ------- |
| **做种时间超过**   | 做种时长达到 N 小时后可删    | 72 小时 |
| **分享率达到**     | 分享率 ≥ N 后可删            | 2.0     |
| **不活跃超过**     | 上传速度为 0 超过 N 小时可删 | 48 小时 |
| **免费到期未完成** | 免费期结束且未下载完的种子   | 开/关   |

**条件关系**：

- **OR 模式**（默认）：满足任意一个条件即可删除。适合快速释放空间。
- **AND 模式**：所有配置的条件都必须同时满足才会删除。更加保守，适合希望充分利用种子价值的场景。

> 设置为 0 的条件不参与判断。例如做种时间设为 72 小时、分享率设为 0，则只按做种时间判断。

### 磁盘空间保护

| 配置项           | 默认值 | 说明                           |
| ---------------- | ------ | ------------------------------ |
| **启用磁盘保护** | 开     |                                |
| **最低剩余空间** | 50 GB  | 剩余空间低于此值时触发保护机制 |

磁盘空间保护提供**双重保护**：

1. **推送拦截**（入口防护）：RSS 自动下载和手动推送在检测到下载器磁盘空间低于阈值时，自动跳过推送，不再往下载器塞新种子。同一批次中一旦检测到空间不足，会立即停止处理剩余种子。
2. **紧急清理**（存量清理）：自动删种定时检查时，如果磁盘空间低于阈值，即使种子没有满足上面的删除条件，也会按以下优先级在管理范围内强制删除：
   1. 已暂停的种子
   2. 分享率已达标的种子（从高到低）
   3. 做种时间最长的种子
   4. 不活跃的种子
   5. 体积最大的种子（释放空间最多）

> **注意**：紧急清理严格遵守管理范围设置。如果管理范围内的可删种子不足以腾出所需空间，系统不会越界删除范围外的种子。此时推送拦截机制会阻止新种子进入，防止磁盘被进一步占满。

### 保护规则

以下种子即使满足删除条件也不会被删除：

| 规则               | 默认值  | 说明                                  |
| ------------------ | ------- | ------------------------------------- |
| **保护下载中种子** | 开      | 正在下载或校验中的种子不删            |
| **保护 H&R 种子**  | 开      | 未满足站点 H&R 做种时长要求的种子不删 |
| **最短保种时间**   | 24 小时 | 添加不满 N 小时的种子不删             |
| **保护标签**       | 空      | 带有指定标签的种子不删（逗号分隔）    |

## 执行逻辑

### RSS 推送流程（入口防护）

```
1. RSS 定时任务触发，解析 RSS 获取种子列表
2. 下载 .torrent 文件到本地
3. 遍历待推送的种子文件：
   a. 检查种子是否过期/已推送/已存在
   b. 检查磁盘空间（如启用保护）：
      - 空间充足 → 推送种子到下载器
      - 空间不足 → 跳过当前种子，停止处理剩余种子
```

### 自动删种流程（存量清理）

```
1. 遍历所有已配置的下载器
2. 获取下载器中的种子列表
3. 按管理范围过滤出"可管理"的种子（严格遵守 scope）
4. 排除受保护的种子（下载中/H&R/保护标签/最短保种时间）
5. 评估删除条件（按 AND/OR 模式判断）
6. 检查磁盘空间（如启用保护）：
   - 空间充足 → 只删除满足条件的种子
   - 空间不足 → 在管理范围内按优先级强制删除直到空间恢复
7. 执行删除 + 更新数据库 + 记录日志
```

## H&R 保护

H&R（Hit & Run）是部分 PT 站点的规则，要求用户下载种子后必须做种一定时长，否则会受到处罚。

**工作原理**：

1. pt-tools 在下载种子时会记录站点返回的 H&R 标记和要求的做种时长
2. 自动删种时会检查数据库中的 H&R 信息
3. 如果种子有 H&R 要求且当前做种时间未达标，该种子会被保护，不会被删除
4. 无 H&R 要求的站点和种子不受影响

> **注意**：并非所有站点都提供 H&R 信息。如果站点未返回 H&R 标记，pt-tools 无法自动识别。建议同时设置合理的最短保种时间作为额外保障。

## 多下载器安全

当配置了多个下载器时：

- 每个下载器**独立处理**，互不影响
- 「仅本应用推送的种子」模式通过数据库中的 `downloader_name` 字段精确匹配种子到对应的下载器
- 不会出现下载器 A 的种子被当作下载器 B 的种子处理的情况

## 常见配置示例

### 场景 1：日常刷流（推荐）

适合大多数用户的保守配置：

| 配置项       | 值                 |
| ------------ | ------------------ |
| 管理范围     | 仅本应用推送的种子 |
| 条件关系     | OR                 |
| 做种时间     | 72 小时            |
| 分享率       | 2.0                |
| 免费到期删除 | 开                 |
| 保护 H&R     | 开                 |
| 最短保种时间 | 24 小时            |
| 磁盘保护     | 开，最低 50 GB     |

### 场景 2：磁盘空间紧张

优先保证磁盘不满：

| 配置项     | 值                 |
| ---------- | ------------------ |
| 管理范围   | 仅本应用推送的种子 |
| 条件关系   | OR                 |
| 做种时间   | 48 小时            |
| 分享率     | 1.0                |
| 不活跃时间 | 24 小时            |
| 磁盘保护   | 开，最低 50 GB     |

### 场景 3：追求高分享率

只有充分利用后才删除：

| 配置项       | 值                 |
| ------------ | ------------------ |
| 管理范围     | 仅本应用推送的种子 |
| 条件关系     | AND                |
| 做种时间     | 168 小时（7 天）   |
| 分享率       | 3.0                |
| 保护 H&R     | 开                 |
| 最短保种时间 | 48 小时            |
| 磁盘保护     | 开，最低 100 GB    |

> AND 模式下，种子必须**同时**做种超过 7 天**且**分享率达到 3.0 才会被删除。
> 建议搭配磁盘保护并设置较大的保底空间，防止高分享率目标导致种子大量堆积撑满硬盘。

---

相关文档：

- [配置说明](../configuration.md)
- [RSS 订阅配置指南](./rss-subscription.md)
- [常见问题 (FAQ)](../faq.md)

[返回首页](../README.md)
